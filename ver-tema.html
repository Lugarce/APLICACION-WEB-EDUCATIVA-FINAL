<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Matienzo - Tema</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>

<div class="layout">

  <!-- SIDEBAR UNIFICADO -->
  <aside class="sidebar">

    <div class="sidebar-header">
      <div class="sidebar-logo"></div>
      <div class="sidebar-title">Matienzo</div>
    </div>

    <nav class="nav-menu">
      <a href="index.html" class="nav-item">
        <svg viewBox="0 0 24 24" stroke="currentColor" fill="none">
          <path d="M3 12l9-9 9 9"/>
          <path d="M9 21V9h6v12"/>
        </svg>
        <span>Inicio</span>
      </a>

      <a href="buscar.html" class="nav-item">
        <svg viewBox="0 0 24 24" stroke="currentColor" fill="none">
          <circle cx="11" cy="11" r="7"/>
          <line x1="16.65" y1="16.65" x2="21" y2="21"/>
        </svg>
        <span>Buscar</span>
      </a>

      <a href="temas.html" class="nav-item">
        <svg viewBox="0 0 24 24" stroke="currentColor" fill="none">
          <rect x="3" y="4" width="18" height="6" rx="2"/>
          <rect x="3" y="14" width="18" height="6" rx="2"/>
        </svg>
        <span>Temas</span>
      </a>

      <a href="recursos.html" class="nav-item">
        <svg viewBox="0 0 24 24" stroke="currentColor" fill="none">
          <path d="M4 4h16v16H4z"/>
          <path d="M4 15l5-5 4 4 3-3 4 4"/>
        </svg>
        <span>Recursos</span>
      </a>

      <a href="autor.html" class="nav-item">
        <svg viewBox="0 0 24 24" stroke="currentColor" fill="none">
          <circle cx="12" cy="7" r="4"/>
          <path d="M4 21c2-4 6-6 8-6s6 2 8 6"/>
        </svg>
        <span>Autor</span>
      </a>
    </nav>

    <!-- CONFIGURACIÓN UNIFICADA -->
    <div class="configuracion">
      <div class="configuracion-box" id="modo-oscuro-box">
        <span>Modo Oscuro</span>
        <div class="toggle-btn" id="toggle-theme"></div>
      </div>
      <div class="configuracion-box" id="reset-datos">
        <span>Reset Datos</span>
      </div>
    </div>

  </aside>

  <!-- CONTENIDO PRINCIPAL -->
  <main class="main">

    <div id="temaContent">
      <div class="card">
        <h2>Cargando tema...</h2>
        <p style="color:var(--clr-text-muted);">Por favor espera mientras se carga el contenido.</p>
      </div>
    </div>

  </main>
</div>

<script src="app.js"></script>

<script>
async function cargarTema() {
  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");

  if (!id) {
    document.getElementById("temaContent").innerHTML = `
      <div class='card'>
        <h2>Tema no especificado</h2>
        <p>No se ha seleccionado ningún tema. Regresa a la página de temas.</p>
        <a href="temas.html" class="btn">Ver Temas</a>
      </div>
    `;
    return;
  }

  let data;
  try {
    const response = await fetch("temas.json");
    data = await response.json();
  } catch (error) {
    console.error("Error cargando temas:", error);
    document.getElementById("temaContent").innerHTML = `
      <div class='card'>
        <h2>Error al cargar el tema</h2>
        <p>No se pudo cargar la información del tema. Intenta nuevamente.</p>
      </div>
    `;
    return;
  }

  const temas = data.temas || [];
  const tema = temas.find(t => t.id === id);

  if (!tema) {
    document.getElementById("temaContent").innerHTML = `
      <div class='card'>
        <h2>Tema no encontrado</h2>
        <p>El tema solicitado no existe o no está disponible.</p>
        <a href="temas.html" class="btn">Ver Temas</a>
      </div>
    `;
    return;
  }

  // Guardar último tema abierto
  try {
    localStorage.setItem("matienzo_last_opened", id);
  } catch (error) {
    console.warn("No se pudo guardar el último tema abierto:", error);
  }

  // Renderizar el tema
  const contenedor = document.getElementById("temaContent");
  contenedor.innerHTML = `
    <h1>${tema.titulo}</h1>
    <p style="color:var(--clr-text-muted); margin-bottom:20px;">
      Curso: <strong>${tema.curso}</strong> • Año: <strong>${tema.anio}°</strong>
    </p>

    <!-- Tarjeta principal -->
    <div class="card">
      <h2>Descripción</h2>
      <p>${tema.descripcion}</p>
      ${tema.imagen ? `<img src="${tema.imagen}" alt="${tema.titulo}" style="width:100%; border-radius:var(--radius); margin-top:12px;" onerror="this.style.display='none'">` : ''}
    </div>

    <!-- Teoría -->
    <div class="card">
      <h2>Teoría</h2>
      <ul class="list">
        ${tema.teoria.map(punto => `<li>${punto}</li>`).join("")}
      </ul>
    </div>

    <!-- Fórmulas -->
    ${tema.formulas && tema.formulas.length > 0 ? `
    <div class="card">
      <h2>Fórmulas</h2>
      <div class="formula-grid">
        ${tema.formulas.map(formula => 
          `<div class="formula-card">${formula}</div>`
        ).join("")}
      </div>
    </div>
    ` : ''}

    <!-- Ejemplos -->
    ${tema.ejemplos && tema.ejemplos.length > 0 ? `
    <div class="card">
      <h2>Ejemplos resueltos</h2>
      ${tema.ejemplos.map(ejemplo => `
        <div class="example-card">
          <p><strong>Ejemplo:</strong> ${ejemplo.pregunta}</p>
          <p><strong>Solución:</strong> ${ejemplo.solucion}</p>
        </div>
      `).join("")}
    </div>
    ` : ''}

    <!-- Flashcards SIMPLIFICADAS - SIN FLIP -->
    <div class="card">
      <h2>Tarjetas de estudio</h2>
      <button class="btn" id="crearFlashBtn">Generar 3 tarjetas</button>
      <button class="btn" id="marcarEstBtn" style="margin-left:10px;">Marcar como estudiado</button>
      <div id="flashcardsArea" class="flashcards-grid" style="margin-top:12px;"></div>
    </div>

    <!-- Mini Quiz -->
    ${tema.quiz && tema.quiz.length > 0 ? `
    <div class="card">
      <h2>Mini Quiz</h2>
      <div id="quizArea">
        ${tema.quiz.map((pregunta, index) => `
          <div class="quiz-question">
            <p><strong>${index + 1}. ${pregunta.pregunta}</strong></p>
            ${pregunta.opciones.map((opcion, opcionIndex) => `
              <label class="quiz-option">
                <input type="radio" name="q${index}" value="${opcionIndex}">
                ${opcion}
              </label>
            `).join("")}
          </div>
        `).join("")}
      </div>
      <button class="btn" id="calificarBtn">Calificar</button>
      <p id="quizResultado" style="margin-top:10px; font-weight:600;"></p>
    </div>
    ` : ''}
  `;

  // Configurar event listeners
  document.getElementById("crearFlashBtn").addEventListener("click", () => crearFlashcards(tema));
  document.getElementById("marcarEstBtn").addEventListener("click", () => marcarEstudiado(tema.id));
  
  if (tema.quiz && tema.quiz.length > 0) {
    document.getElementById("calificarBtn").addEventListener("click", () => calificarQuiz(tema));
  }
}

// FUNCIÓN COMPLETAMENTE SIMPLIFICADA - SIN FLIP, CONTENIDO DIRECTO
function crearFlashcards(tema) {
  const area = document.getElementById("flashcardsArea");
  if (!area) return;

  // Limpiar área primero
  area.innerHTML = "";
  area.className = "flashcards-grid";

  // Crear EXACTAMENTE 3 tarjetas con CONTENIDO DIFERENTE
  const tarjetas = [];

  // Tarjeta 1: CONCEPTO PRINCIPAL
  if (tema.descripcion) {
    tarjetas.push({
      pregunta: "Concepto Principal",
      respuesta: tema.descripcion
    });
  }

  // Tarjeta 2: PUNTO CLAVE DE TEORÍA
  if (tema.teoria && tema.teoria.length > 0) {
    // Usar diferentes puntos de teoría para diferentes tarjetas
    const puntosTeoria = tema.teoria.slice(0, 2); // Tomar primeros 2 puntos
    
    puntosTeoria.forEach((punto, index) => {
      if (tarjetas.length < 3) { // Asegurar máximo 3 tarjetas
        let pregunta = "";
        
        // Crear preguntas específicas según el contenido
        if (punto.includes("numerador") || punto.includes("denominador")) {
          pregunta = "Partes de una fracción";
        } else if (punto.includes("suma") || punto.includes("sumar")) {
          pregunta = "Operación de suma";
        } else if (punto.includes("decimal")) {
          pregunta = "Números decimales";
        } else if (punto.includes("ecuación")) {
          pregunta = "Ecuaciones lineales";
        } else if (punto.includes("congruente")) {
          pregunta = "Congruencia de triángulos";
        } else if (punto.includes("divisible")) {
          pregunta = "Divisibilidad";
        } else if (punto.includes("expresión algebraica")) {
          pregunta = "Expresiones algebraicas";
        } else if (punto.includes("factor común")) {
          pregunta = "Factorización";
        } else if (punto.includes("cuadrilátero")) {
          pregunta = "Cuadriláteros";
        } else if (punto.includes("seno") || punto.includes("coseno")) {
          pregunta = "Razones trigonométricas";
        } else if (punto.includes("identidad")) {
          pregunta = "Identidades trigonométricas";
        } else {
          pregunta = `Punto clave ${index + 1}`;
        }
        
        tarjetas.push({
          pregunta: pregunta,
          respuesta: punto
        });
      }
    });
  }

  // Tarjeta 3: FÓRMULA O EJEMPLO
  if (tema.formulas && tema.formulas.length > 0 && tarjetas.length < 3) {
    tarjetas.push({
      pregunta: "Fórmula importante",
      respuesta: tema.formulas[0]
    });
  } else if (tema.ejemplos && tema.ejemplos.length > 0 && tarjetas.length < 3) {
    const ejemplo = tema.ejemplos[0];
    tarjetas.push({
      pregunta: "Ejemplo práctico",
      respuesta: `${ejemplo.pregunta} → ${ejemplo.solucion}`
    });
  }

  // Asegurarnos de que solo tenemos 3 tarjetas
  const tarjetasFinales = tarjetas.slice(0, 3);

  // Renderizar las 3 tarjetas SIN FLIP - CONTENIDO DIRECTO
  tarjetasFinales.forEach((tarjeta) => {
    const cardElement = document.createElement("div");
    cardElement.className = "flashcard-simple";
    
    // Crear estructura HTML SIMPLE - sin efectos de flip
    cardElement.innerHTML = `
      <div class="flashcard-question">${tarjeta.pregunta}</div>
      <div class="flashcard-answer">${tarjeta.respuesta}</div>
    `;

    area.appendChild(cardElement);
  });

  // Guardar en localStorage
  const textosParaGuardar = tarjetasFinales.map(t => 
    `${tema.id}::${t.pregunta}::${t.respuesta}`
  );
  
  window.matienzo.saveFlashcardsRaw(textosParaGuardar);
}

// Marcar como estudiado
function marcarEstudiado(id) {
  try {
    window.matienzo.addStudied(id);
    const boton = document.getElementById("marcarEstBtn");
    if (boton) {
      boton.textContent = "✓ Estudiado";
      boton.style.background = "var(--clr-accent-warm)";
    }
    
    // Mostrar notificación temporal
    const notificacion = document.createElement("div");
    notificacion.style.cssText = "position:fixed; top:20px; right:20px; padding:12px 20px; background:var(--clr-accent); color:white; border-radius:var(--radius); z-index:1000;";
    notificacion.textContent = "✓ Tema marcado como estudiado";
    document.body.appendChild(notificacion);
    
    setTimeout(() => notificacion.remove(), 2000);
  } catch (error) {
    console.warn("Error marcando tema como estudiado:", error);
    alert("Error al marcar el tema como estudiado");
  }
}

// Calificar quiz
function calificarQuiz(tema) {
  let puntaje = 0;
  const totalPreguntas = tema.quiz.length;

  tema.quiz.forEach((pregunta, index) => {
    const opcionSeleccionada = document.querySelector(`input[name="q${index}"]:checked`);
    if (opcionSeleccionada && parseInt(opcionSeleccionada.value) === pregunta.respuesta) {
      puntaje++;
    }
  });

  const resultadoElemento = document.getElementById("quizResultado");
  const porcentaje = Math.round((puntaje / totalPreguntas) * 100);
  
  let mensaje = "";
  if (porcentaje >= 80) {
    mensaje = `Excelente: ${puntaje}/${totalPreguntas} (${porcentaje}%)`;
    resultadoElemento.style.color = "var(--clr-accent)";
  } else if (porcentaje >= 60) {
    mensaje = `Buen trabajo: ${puntaje}/${totalPreguntas} (${porcentaje}%)`;
    resultadoElemento.style.color = "var(--clr-accent-warm)";
  } else {
    mensaje = `Sigue practicando: ${puntaje}/${totalPreguntas} (${porcentaje}%)`;
    resultadoElemento.style.color = "var(--clr-text-muted)";
  }
  
  resultadoElemento.textContent = mensaje;
}

// Iniciar carga del tema cuando el DOM esté listo
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", cargarTema);
} else {
  cargarTema();
}
</script>

</body>
</html>